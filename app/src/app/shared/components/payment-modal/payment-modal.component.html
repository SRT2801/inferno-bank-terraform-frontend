<div *ngIf="isOpen" class="modal-overlay fixed inset-0 z-[9998] bg-black/60 backdrop-blur-sm"
  (click)="onOverlayClick($event)">
  <div
    class="modal-scroll-container w-full sm:max-w-md bg-gradient-to-br from-gray-900 via-purple-900/30 to-gray-900 shadow-2xl overflow-y-auto"
    #modalContent>
    <!-- Header -->
    <div class="sticky top-0 z-10 glass-card border-b border-white/10 px-4 sm:px-6 py-3 sm:py-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl sm:text-2xl font-bold text-white flex items-center gap-2">
          <span class="material-symbols-outlined text-purple-400 text-2xl sm:text-3xl">payment</span>
          <span class="hidden xs:inline">Make payment</span>
          <span class="xs:hidden">Make payment</span>
        </h2>
        <button (click)="onClose()" [disabled]="isProcessing"
          class="text-gray-400 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          <span class="material-symbols-outlined text-2xl sm:text-3xl">close</span>
        </button>
      </div>
    </div>

    <!-- Content -->
    <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
      <!-- Service Details -->
      <div *ngIf="service && !showSuccess" class="glass-card rounded-xl p-4 sm:p-6 space-y-3 sm:space-y-4">
        <h3 class="text-base sm:text-lg font-semibold text-white mb-3 sm:mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-blue-400 text-xl sm:text-2xl">receipt_long</span>
          <span>Purchase Summary</span>
        </h3>

        <div class="space-y-2 sm:space-y-3">
          <div class="flex justify-between items-start gap-2">
            <span class="text-gray-400 text-xs sm:text-sm">Service:</span>
            <span class="text-white font-medium text-right text-xs sm:text-sm">{{ service.servicio }}</span>
          </div>

          <div class="flex justify-between items-start gap-2">
            <span class="text-gray-400 text-xs sm:text-sm">Provider:</span>
            <span class="text-white font-medium text-right text-xs sm:text-sm">{{ service.proveedor }}</span>
          </div>

          <div class="flex justify-between items-start gap-2">
            <span class="text-gray-400 text-xs sm:text-sm">Plan:</span>
            <span class="text-white font-medium text-right text-xs sm:text-sm">{{ service.plan }}</span>
          </div>

          <div class="flex justify-between items-start gap-2">
            <span class="text-gray-400 text-xs sm:text-sm">Category:</span>
            <span class="text-white font-medium text-right">
              <span class="px-2 py-1 bg-purple-500/20 text-purple-300 rounded-lg text-xs">
                {{ service.categoria }}
              </span>
            </span>
          </div>

          <div class="flex justify-between items-start gap-2">
            <span class="text-gray-400 text-xs sm:text-sm">Details:</span>
            <span class="text-white font-medium text-right max-w-[60%] text-xs sm:text-sm">{{ service.velocidadDetalles
              }}</span>
          </div>

          <div class="border-t border-white/10 pt-2 sm:pt-3 mt-2 sm:mt-3">
            <div class="flex justify-between items-center">
              <span class="text-gray-400 font-semibold text-sm sm:text-base">Total to Pay:</span>
              <span class="text-xl sm:text-2xl font-bold text-green-400">{{ formatPrice(service.precioMensual) }}</span>
            </div>
            <p class="text-xs text-gray-500 text-right mt-1">Monthly payment</p>
          </div>
        </div>
      </div>

      <!-- Payment Form -->
      <div *ngIf="!showSuccess" class="glass-card rounded-xl p-4 sm:p-6">
        <h3 class="text-base sm:text-lg font-semibold text-white mb-3 sm:mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-green-400 text-xl sm:text-2xl">credit_card</span>
          <span>Payment Information</span>
        </h3>

        <form (ngSubmit)="processPayment()" class="space-y-3 sm:space-y-4">
          <div>
            <label for="cardId" class="block text-xs sm:text-sm font-medium text-gray-300 mb-2">
              Enter your card's cardId
            </label>
            <input type="text" id="cardId" [(ngModel)]="cardId" name="cardId"
              placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" [disabled]="isProcessing"
              class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all disabled:opacity-50 disabled:cursor-not-allowed"
              required />
            <p class="text-xs text-gray-500 mt-1">Enter your card's UUID</p>
          </div>

          <button type="submit" [disabled]="isProcessing || !cardId.trim()"
            class="w-full py-2.5 sm:py-3 px-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span *ngIf="!isProcessing" class="material-symbols-outlined text-xl sm:text-2xl">check_circle</span>
            <span *ngIf="isProcessing"
              class="material-symbols-outlined animate-spin text-xl sm:text-2xl">progress_activity</span>
            <span>{{ isProcessing ? 'Processing...' : 'Confirm Payment' }}</span>
          </button>
        </form>

        <div class="mt-3 sm:mt-4 p-2.5 sm:p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg">
          <div class="flex gap-2">
            <span class="material-symbols-outlined text-blue-400 text-sm flex-shrink-0">info</span>
            <p class="text-xs text-blue-300">
              Your payment will be processed securely. You will receive a tracking ID once completed.
            </p>
          </div>
        </div>
      </div>

      <!-- Success Message -->
      <div *ngIf="showSuccess" class="glass-card rounded-xl p-6 sm:p-8 text-center space-y-3 sm:space-y-4">
        <div
          class="w-16 h-16 sm:w-20 sm:h-20 mx-auto bg-green-500/20 rounded-full flex items-center justify-center animate-pulse">
          <span class="material-symbols-outlined text-green-400 text-4xl sm:text-5xl">check_circle</span>
        </div>

        <h3 class="text-xl sm:text-2xl font-bold text-white">Payment Successful!</h3>
        <p class="text-sm sm:text-base text-gray-300">Your payment has been processed successfully</p>

        <div class="bg-white/5 border border-white/10 rounded-lg p-3 sm:p-4">
          <p class="text-xs sm:text-sm text-gray-400 mb-1">Tracking ID:</p>
          <p class="text-white font-mono text-xs sm:text-sm break-all">{{ traceId }}</p>
        </div>

        <div class="pt-3 sm:pt-4">
          <button (click)="onClose()"
            class="px-4 sm:px-6 py-2 text-sm sm:text-base bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors">
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div *ngIf="isProcessing"
      class="absolute inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
      <div class="glass-card p-4 sm:p-6 rounded-xl text-center mx-4 max-w-sm">
        <div
          class="animate-spin rounded-full h-10 w-10 sm:h-12 sm:w-12 border-b-2 border-purple-500 mx-auto mb-3 sm:mb-4">
        </div>
        <p class="text-white text-sm sm:text-base font-semibold mb-2">{{ paymentStatusMessage || 'Procesando pago...' }}
        </p>
        <p class="text-gray-400 text-xs sm:text-sm mt-1 sm:mt-2">Por favor espera mientras verificamos tu pago</p>

        <div *ngIf="traceId" class="mt-3 sm:mt-4 bg-white/5 border border-white/10 rounded-lg p-2 sm:p-3">
          <p class="text-xs text-gray-400 mb-1">ID de seguimiento:</p>
          <p class="text-white font-mono text-xs break-all">{{ traceId }}</p>
        </div>
      </div>
    </div>
  </div>
</div>